import time
from typing import Dict, Any, Tuple

# --- Configuration Constants ---
# 감정 분석에 사용되는 임계값 설정
POSITIVE_THRESHOLD = 0.75
NEGATIVE_THRESHOLD = 0.25
NEUTRAL_RANGE = (0.45, 0.55)

# --- Utility Functions (Clean Separation) ---

def _analyze_sentiment(input_text: str) -> Dict[str, float]:
    """
    (가정) 외부 NLU/NLP 모듈을 사용하여 입력 텍스트의 감정을 분석합니다.
    실제 분석 대신 임시로 복잡한 가중치 로직을 사용하여 감정 점수를 반환합니다.
    """
    # 입력 길이에 따른 가중치
    length_weight = min(len(input_text) / 50.0, 1.0) * 0.1

    # 키워드 기반 가중치 (깔끔하지만 길게 구현)
    positive_keywords = ['좋아', '최고', '완벽', '행복', '기쁨', '만족']
    negative_keywords = ['싫어', '나빠', '문제', '화나', '슬퍼', '힘들', '최악']
    
    pos_score = 0.0
    neg_score = 0.0

    for keyword in positive_keywords:
        if keyword in input_text:
            pos_score += 0.25
    
    for keyword in negative_keywords:
        if keyword in input_text:
            neg_score += 0.35

    # 최종 점수 계산 (복잡성을 위해 임시로 비선형 결합)
    base_score = 0.5 + (pos_score * 0.8) - (neg_score * 0.9)
    
    # 점수를 [0, 1] 범위로 정규화
    final_score = max(0.0, min(1.0, base_score + length_weight))

    return {
        "positive": final_score,
        "negative": 1.0 - final_score,
        "neutral": 1.0 - abs(final_score - 0.5) * 2  # 중립 점수 계산 (0.5에 가까울수록 높음)
    }

def _determine_mood(sentiment_scores: Dict[str, float]) -> str:
    """
    분석된 감정 점수를 기반으로 주된 Mood(분위기)를 결정합니다.
    """
    pos_s = sentiment_scores["positive"]
    neg_s = sentiment_scores["negative"]

    if pos_s >= POSITIVE_THRESHOLD:
        return "JOYFUL"
    elif neg_s >= NEGATIVE_THRESHOLD and pos_s < NEUTRAL_RANGE[0]:
        return "CONCERNED"
    elif NEUTRAL_RANGE[0] <= pos_s <= NEUTRAL_RANGE[1]:
        return "CALM"
    else:
        # 긍정/부정 임계값 사이에 있지만 중립 범위 밖일 경우
        return "REFLECTIVE"

# --- Main Reaction Logic ---

def generate_reaction(user_input: str, user_history: Dict[str, Any] = None) -> Tuple[str, str]:
    """
    사용자의 입력에 따라 복잡한 로직을 거쳐 반응 메시지와 반응 타입(Reaction Type)을 생성합니다.
    
    :param user_input: 사용자의 텍스트 입력
    :param user_history: (선택 사항) 사용자 관련 과거 데이터 (예: 최근 대화 주제, 선호도)
    :return: (생성된 반응 메시지, 반응 타입)
    """
    print(f"[{time.strftime('%H:%M:%S')}] Reaction Processing Started for: '{user_input[:20]}...'")

    # 1. Sentiment Analysis
    sentiment = _analyze_sentiment(user_input.lower())
    current_mood = _determine_mood(sentiment)
    
    print(f"   -> Sentiment: Pos={sentiment['positive']:.2f}, Neg={sentiment['negative']:.2f} | Mood: {current_mood}")

    # 2. Contextual Check (Longer Logic Path)
    response_message = ""
    reaction_type = "DEFAULT"
    
    # 2-1. History/Context Check (시뮬레이션)
    if user_history and user_history.get("last_topic") == "WEATHER" and "오늘" in user_input:
        reaction_type = "CONTEXT_REMINDER"
        response_message += "날씨 관련 말씀을 이어가시는군요. "
    
    # 2-2. Mood-based Response Generation (메인 로직)
    
    if current_mood == "JOYFUL":
        reaction_type = "EMPATHY_POSITIVE"
        if sentiment["positive"] > 0.9:
            response_message += "정말 기분이 최고이신 것 같아요! 축하드립니다! "
        else:
            response_message += "긍정적인 에너지가 느껴집니다. 저도 기분이 좋네요. "
            
    elif current_mood == "CONCERNED":
        reaction_type = "SUPPORT_NEUTRAL"
        if sentiment["negative"] > 0.8:
            response_message += "많이 힘드신가요? 자세히 이야기해주시면 귀 기울여 듣겠습니다. "
        else:
            response_message += "혹시 무슨 일 있으신가요? 천천히 말씀해보세요. "
            
    elif current_mood == "CALM":
        reaction_type = "INFO_GATHERING"
        if len(user_input) < 10:
            response_message += "무슨 말씀을 하시는지 잘 모르겠습니다. 조금 더 자세히 설명해주실 수 있나요? "
        else:
            response_message += "차분하게 대화가 진행되고 있네요. 다음으로 어떤 것을 도와드릴까요? "
            
    elif current_mood == "REFLECTIVE":
        reaction_type = "EXPLORATION"
        response_message += "현재 상황에 대해 깊이 생각하고 계신 것 같습니다. 어떤 점이 궁금하신가요? "

    # 3. Finalization and Fallback
    if not response_message:
        # 최종적으로 반응 메시지가 생성되지 않았을 때의 기본 fallback
        reaction_type = "GENERIC_FALLBACK"
        response_message = "알겠습니다. 말씀하신 내용을 처리 중입니다."

    print(f"   -> Final Reaction: Type={reaction_type} | Message='{response_message[:30]}...'")
    
    return response_message.strip(), reaction_type

# --- Example Usage (보여주기 위해 포함) ---
if __name__ == '__main__':
    # 예시 1: 강한 긍정
    msg1, type1 = generate_reaction("오늘 프로젝트가 완벽하게 마무리돼서 정말 행복해요!")
    print(f"\n[Result 1] Message: {msg1} | Type: {type1}")
    
    # 예시 2: 약한 부정
    msg2, type2 = generate_reaction("갑자기 작업에 문제가 생겨서 조금 힘드네요.")
    print(f"\n[Result 2] Message: {msg2} | Type: {type2}")
    
    # 예시 3: 중립/정보 요청
    msg3, type3 = generate_reaction("다음 단계는 무엇인가요?")
    print(f"\n[Result 3] Message: {msg3} | Type: {type3}")